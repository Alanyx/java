# 不要依赖线程调度器

## 为什么不要依赖？

任何依赖线程调度器来保证正确性或性能的程序都可能是不可移植的。

## 建议

- 保持可运行线程数量少的主要技术是让每个线程做一些有用的工作，然后等待更多的工作。

> 如果线程没有做有用的工作，它们就不应该运行。
>
> eg: 对于 Executor 框架（详见第 80 条），这意味着适当调整线程池的大小，并保持任务短小（但不要太短），否则分派的开销依然会损害性能。

- 线程不应该处于忙等待状态（busy-wait），应该反复检查一个共享对象，等待它的状态发生变化。

> 忙等待不仅使程序易受到线程调度器变化的影响，还增加了处理器的负载，影响其他人完成工作。【见示例代码 SlowCountDownLatch】

## 反例

- Thread.yield 没有可测试的语义。 更好的做法是重构应用程序，以减少并发运行线程的数量。

> 由于某些线程相对于其他线程没有获得足够的 CPU 时间,造成一个程序几乎不能工作，那么通过调用 Thread.yield 来「修复」程序 你也许能勉强让程序运行起来，但它是不可移植的。

- 调整线程优先级来调优应用程序的响应性并非不合理，但很少情况下是必要的，而且不可移植。

> 有一些服务器不支持线程优先级。

## 小结

总之，不要依赖线程调度器来判断程序的正确性。生成的程序既不健壮也不可移植。

因此，不要依赖 Thread.yield 或线程优先级。这些工具只是对调度器的提示。

线程优先级可以少量地用于提高已经工作的程序的服务质量，但绝不应该用于「修复」几乎不能工作的程序。